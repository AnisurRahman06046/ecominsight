<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcomInsight Query Tester</title>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .examples {
            margin-top: 15px;
        }

        .examples p {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .example-query {
            display: inline-block;
            background: #f0f0f0;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
            margin: 3px;
            transition: all 0.2s;
        }

        .example-query:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            margin-top: 20px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .result-header h3 {
            color: #333;
            font-size: 1.3em;
        }

        .metadata {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .meta-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        .meta-label {
            color: #666;
            font-weight: 600;
        }

        .meta-value {
            color: #333;
            margin-left: 5px;
        }

        .confidence-high { color: #22c55e; font-weight: 700; }
        .confidence-medium { color: #f59e0b; font-weight: 700; }
        .confidence-low { color: #ef4444; font-weight: 700; }

        .answer-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }

        .answer-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .answer-text {
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .data-section {
            margin-top: 15px;
        }

        .data-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .json-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }

        .error {
            background: #fee;
            border-left: 4px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-success {
            background: #dcfce7;
            color: #15803d;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç EcomInsight Query Tester</h1>
            <p>Test your natural language queries with MCP tools</p>
        </div>

        <div class="card">
            <div class="input-group">
                <label for="shopSelect">Select Shop</label>
                <select id="shopSelect" style="width: 100%;">
                    <option value="">Loading shops...</option>
                </select>
            </div>

            <div class="input-group">
                <label for="query">Your Question</label>
                <textarea id="query" placeholder="Ask anything about your e-commerce data..."></textarea>
            </div>

            <div class="examples">
                <p><strong>Example Queries:</strong></p>
                <span class="example-query" onclick="setQuery('How many orders are there?')">How many orders?</span>
                <span class="example-query" onclick="setQuery('What is the total revenue?')">Total revenue</span>
                <span class="example-query" onclick="setQuery('Show me top 5 best selling products')">Top products</span>
                <span class="example-query" onclick="setQuery('What is the average order value?')">Average order value</span>
                <span class="example-query" onclick="setQuery('Which products generated the most revenue in orders with delivery charges above 15, and what percentage of those orders were paid versus unpaid, but only considering customers who have placed at least 3 orders?')">Complex query</span>
            </div>

            <div class="input-group">
                <label for="apiSelect">API Endpoint</label>
                <select id="apiSelect" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                    <option value="/api/mcp/ask">Current System (MCP - HuggingFace)</option>
                    <option value="/api/openrouter/ask">OpenRouter Testing (Free Gemini/Llama)</option>
                </select>
            </div>

            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="submitQuery()" id="submitBtn">
                    üöÄ Ask Question
                </button>
                <button class="btn-secondary" onclick="clearAll()">
                    üóëÔ∏è Clear
                </button>
            </div>
        </div>

        <div id="loadingSection" class="card" style="display: none;">
            <div class="loading">
                <div class="spinner"></div>
                <p>Processing your query...</p>
            </div>
        </div>

        <div id="resultSection" class="card" style="display: none;">
            <div class="result-header">
                <h3>üìä Results</h3>
                <span id="statusBadge" class="status-badge"></span>
            </div>

            <div class="metadata" id="metadata"></div>

            <div class="answer-box">
                <h4>Answer</h4>
                <div class="answer-text" id="answerText"></div>
            </div>

            <div class="data-section">
                <h4>Raw Response Data</h4>
                <div class="json-viewer" id="jsonData"></div>
            </div>
        </div>

        <div id="errorSection" class="card" style="display: none;">
            <div class="error" id="errorMessage"></div>
        </div>
    </div>

    <script>
        function setQuery(query) {
            document.getElementById('query').value = query;
        }

        function clearAll() {
            document.getElementById('query').value = '';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
        }

        async function submitQuery() {
            const shopId = document.getElementById('shopSelect').value;
            const query = document.getElementById('query').value;
            const apiEndpoint = document.getElementById('apiSelect').value;

            if (!shopId || !query) {
                alert('Please select a shop and enter a query');
                return;
            }

            // Hide previous results
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        shop_id: shopId,
                        question: query
                    })
                });

                const data = await response.json();

                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;

                if (response.ok) {
                    displayResults(data, apiEndpoint);
                } else {
                    displayError(data.detail || 'An error occurred');
                }
            } catch (error) {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                displayError('Network error: ' + error.message);
            }
        }

        function displayResults(data, apiEndpoint) {
            document.getElementById('resultSection').style.display = 'block';

            // Status badge
            const badge = document.getElementById('statusBadge');
            badge.textContent = 'Success';
            badge.className = 'status-badge status-success';

            // Metadata
            const metadata = document.getElementById('metadata');
            const tool = data.metadata?.tool_used || data.metadata?.tool_name || 'N/A';
            const confidence = data.metadata?.confidence || 0;
            const time = data.processing_time ? data.processing_time.toFixed(2) + 's' : 'N/A';
            const model = data.metadata?.model || 'N/A';
            const apiType = apiEndpoint.includes('openrouter') ? 'OpenRouter' : 'MCP (HuggingFace)';

            let confidenceClass = 'confidence-low';
            if (confidence >= 0.8) confidenceClass = 'confidence-high';
            else if (confidence >= 0.6) confidenceClass = 'confidence-medium';

            let metadataHtml = `
                <div class="meta-item">
                    <span class="meta-label">API:</span>
                    <span class="meta-value">${apiType}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Tool:</span>
                    <span class="meta-value">${tool}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Time:</span>
                    <span class="meta-value">${time}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Query Type:</span>
                    <span class="meta-value">${data.query_type || 'mcp'}</span>
                </div>
            `;

            // Add confidence only for MCP
            if (!apiEndpoint.includes('openrouter')) {
                metadataHtml += `
                    <div class="meta-item">
                        <span class="meta-label">Confidence:</span>
                        <span class="meta-value ${confidenceClass}">${(confidence * 100).toFixed(0)}%</span>
                    </div>
                `;
            } else {
                metadataHtml += `
                    <div class="meta-item">
                        <span class="meta-label">Model:</span>
                        <span class="meta-value">${model}</span>
                    </div>
                `;
            }

            metadata.innerHTML = metadataHtml;

            // Answer
            document.getElementById('answerText').textContent = data.answer || 'No answer provided';

            // JSON data
            document.getElementById('jsonData').textContent = JSON.stringify(data, null, 2);
        }

        function displayError(message) {
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').innerHTML = `<strong>Error:</strong> ${message}`;
        }

        // Allow Enter key to submit
        document.getElementById('query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                submitQuery();
            }
        });

        // Load shops on page load
        async function loadShops() {
            try {
                const response = await fetch('/api/shops');
                const data = await response.json();

                if (data.success && data.shops) {
                    const shopSelect = document.getElementById('shopSelect');
                    shopSelect.innerHTML = '<option value="">Select a shop...</option>';

                    data.shops.forEach(shop => {
                        const option = document.createElement('option');
                        option.value = shop.id;
                        option.textContent = `${shop.id} - ${shop.name}`;
                        shopSelect.appendChild(option);
                    });

                    // Set default shop (ID 10)
                    shopSelect.value = '10';

                    // Initialize Select2 for search functionality
                    $('#shopSelect').select2({
                        placeholder: 'Search and select a shop...',
                        allowClear: true,
                        width: '100%'
                    });
                } else {
                    console.error('Failed to load shops');
                }
            } catch (error) {
                console.error('Error loading shops:', error);
                document.getElementById('shopSelect').innerHTML = '<option value="10">10 - Default Shop</option>';
            }
        }

        // Load shops when page loads
        loadShops();
    </script>

    <!-- jQuery (required for Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</body>
</html>